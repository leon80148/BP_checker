
# 2023-08-15.md

## ESP32-S3 血壓機數據監控系統交接文件

### 專案概述

本專案使用ESP32-S3開發板建立了一個血壓機數據監控系統，通過RS-232接口連接傳統血壓計，並通過WiFi進行數據傳輸和遠程監控。系統具有以下主要功能：

- 透過RS-232接收血壓機數據
- 提供網頁界面顯示血壓數據
- 支持WiFi配置的AP模式自動設定
- 支持mDNS服務(hostname.local)訪問
- 同時保持AP與STA雙模式連接
- 提供WiFi配置重設功能

### 硬體配置

- **主控制器**：ESP32-S3開發板
- **通訊模組**：RS-232轉TTL模組
- **接口定義**：
  - RS-232轉TTL模組 → ESP32-S3
  - TX → RX (GPIO16)
  - RX → TX (GPIO17)
  - GND → GND
  - VCC → 3.3V
- **重設按鈕**：GPIO0 (板載按鈕)

### 軟體架構

程式基於Arduino框架開發，主要模組包括：

1. **WiFi連接管理**
   - 自動AP模式初始設定
   - Station模式連接已設置的WiFi
   - 雙模式運行支持

2. **Web伺服器**
   - 監控頁面(/)：顯示實時血壓數據
   - 設定頁面(/config)：配置WiFi設定
   - 重置功能(/reset)：清除WiFi設定

3. **數據採集與處理**
   - 實時讀取RS-232串口數據
   - 轉換為十六進制顯示格式
   - 通過Web界面更新

4. **存儲管理**
   - 使用Preferences庫儲存WiFi配置
   - 支持重置和恢復出廠設定

### 開發歷程記錄

1. **初始版本(藍牙通訊)**
   - 嘗試使用BLE進行數據傳輸
   - 遇到ESP32-S3上藍牙連接反覆斷開問題
   - 錯誤表現：`BT_HCI: CC evt: op=0x0222, status=0x2`

2. **轉換為WiFi通訊**
   - 解決了藍牙連接不穩定問題
   - 實現了通過網頁查看血壓數據

3. **AP模式初始化設定**
   - 增加了首次啟動自動進入AP模式的功能
   - 實現了通過手機/平板配置WiFi

4. **mDNS與雙模式支援**
   - 添加了mDNS服務，可通過`esp32bp.local`訪問
   - 實現了AP+STA雙模式同時運行

5. **添加重置功能**
   - Web界面添加重置選項
   - 實現了硬件按鈕(GPIO0)長按重置

### 使用說明

1. **首次啟動**
   - 設備自動啟動AP模式，建立"ESP32_BP_Setup"WiFi熱點
   - 密碼: 12345678
   - 連接後訪問192.168.4.1進行WiFi設定

2. **數據監控**
   - 成功配置WiFi後，可通過以下方式訪問:
     - http://esp32bp.local
     - 或設備獲取的IP地址
   - 監控頁面每3秒自動刷新

3. **設定修改**
   - 點擊監控頁面右上角"WiFi設定"進入配置
   - 設備會保持AP模式開啟，方便隨時訪問和修改

4. **重置系統**
   - 通過網頁點擊"重置WiFi設定"
   - 或長按開發板上的GPIO0按鈕3秒

### 已知問題與待改進

1. **mDNS支持**
   - 某些Android設備不支持mDNS，需使用IP直接訪問

2. **數據解析**
   - 目前僅顯示原始十六進制數據
   - 待增加血壓計協議解析，直接顯示測量值

3. **數據存儲**
   - 待添加歷史數據記錄功能
   - 可考慮添加數據導出功能

4. **界面優化**
   - 可添加更美觀的數據視覺化展示
   - 考慮添加多語言支持

### 測試方法

1. **硬件連接測試**
   - 串口監視器(115200 bps)查看啟動信息
   - 確認RS-232連接狀態

2. **WiFi連接測試**
   - 確認設備是否自動連接已設置WiFi
   - 檢查AP熱點是否同時可用

3. **數據傳輸測試**
   - 觸發血壓計進行測量
   - 查看網頁是否顯示數據
   - 檢查串口監視器中數據輸出

### 開發環境

- Arduino IDE 2.3.5
- ESP32 Arduino Core 3.2.0
- 開發庫依賴：WiFi, WebServer, Preferences, ESPmDNS

---

如有任何問題，請聯絡前任開發者。本文檔作為開發交接使用，包含系統架構、功能和已知問題等關鍵信息。
